# ltx.rb

### 動機

LaTeXソースが大きい場合は、複数のソースファイルに分けて編集するのが効率的である。
普通は、1つのファイルに\\documentclasコマンドと、\\begin\{document\}と\\end\{document\}がある。
そのファイルをルートファイルと呼ぶ。
そのファイルから\\inputコマンドなどで取り込まれるファイルをサブファイルと呼ぶ。
簡単な例として、章が3つあり、それぞれの章がサブファイルになる場合を示そう。

    % The name of the root file is main.tex
    \documentclass{book}
    \begin{document}
    \chapter{Introduction}
    \input{intro.tex}
    \chapter{Body of the book}
    \input{body.tex}
    \chapter{Conclusion}
    \input{conclusion.tex}
    \end{document}

この例では、「main.tex」というルートファイルから、「intro.tex」「body.tex」「conclusion.tex」の3つのサブファイルが呼ばれて挿入されている。

このように複数のソースファイルから成る場合、それらを対応するメモリバッファにコピーして、何らかの作業（例えば一括置換）を行えれば便利ではないだろうか。
例えば、最初はarticleドキュメントを作っていて、どんどん分量が大きくなり、bookドキュメントに変更したくなったとする。
各sectionはchapterに直し、subsectionはsectionに直すなどの作業が必要になるだろう。
それをいちいち手作業でやるよりは、スクリプト（例えばrubyのスクリプト）を書いて置換したほうが早いし正確だ。
この例のような作業に対する各種サービスを提供するクラスとして「Ltx」クラスを開発した。
LtxはもちろんLaTeXの短縮である。

Ltxには作成当初はいろいろな機能を入れていたが、使ってみるとそれらはほとんど必要なかった。
そこで、今度は逆に、できるだけシンプルなクラスにすることを目標に全面的に書き直した。
このクラスは\\includeコマンドをサポートしていない。
しかし、\\includeコマンドをサポートするクラスも同様に作ることができるだろう。
ただ、\\includeonlyコマンドもサポートしなければならないので、多少プログラムが複雑になると思う。

### 初期化と主なメソッド

クラスLtxはインスタンス生成時にLaTeXのソースを読み込み、バッファに保存する。
その（最初に読み込まれる）ファイルを、メインファイルという。
メインファイルに\\inputコマンドがあれば、その引数で与えられるサブファイルを（メイン・ファイルとは別の）バッファに保存する。
\\inputコマンドがネストしていても同様に別バッファに保存され、それらは、インスタンス内部では、メインファイルから順にたどっていくことができる。
このようにしてLaTeXソースファイルとLtx内のバッファは1対1に対応する。

メインファイルは、ルートファイルであってもサブファイルであっても構わない。
だが、通常はルートファイルをメインファイルにすることが多いと思う。

初期化が終了すると、メソッドを使って次のようなことができる。

###### 情報の取得

メインファイルの\\documentclassコマンドから\\begin\{document\}の前までをプリアンブルという。
ここでは、\\begin\{document\}から\\end\{document\}までの間をボディ、それ以降をポストドキュメントと呼ぶことにする。

- メインファイル名、サブファイル名（の一覧）を取得する
- メインファイルとサブファイルを行単位で取得するdeep\_eachとshallow\_eachメソッドがある。deep\_eachはボディ内のすべてのファイルから各行をとりだすが、shallow\_eachはメインファイルのみから行を取り出す。

###### バッファの内容変更

- 2つのeachコマンドにおいては、バッファ内部の文字列（破壊的メソッドで）を変更することができる

###### ファイルへの書き込みなど

- バッファの内容をLaTeXソースファイルに上書きする
- バックアップ（「ファイル名\.bak」）にバッファの内容を書き出す

### エラー処理

Ltxの内部ではエラー処理をほとんどしていない。

### カレントディレクトリについて

Ltxでは、ファイルのオープンの際に特別なことは何もしていない。しかし、通常\\input\{ファイル名\}では、メインファイルからの相対パスが使われることが多い。それは、ディレクトリ移動に対応するためである。例えばAというユーザが作ったLaTeXソースをBという別のユーザがコピーして使うという場合を考えてみる。ソースのあるディレクトリは、例えば/home/Aから/home/Bに変わるので、絶対パスで\\inputを用いると（例えば\\input\{/home/A/subfile\.tex\}）、Bがコンパイルするときに/home/B/subfile\.texではなくて、/home/A/subfile\.texを取り込むことになる。もしもユーザBがsubfile\.tex（これは/home/B/subfile\.tex）を改変したとしても、コンパイル時に/home/A/subfile\.texを取り込んでいては変更が反映されない。これは見つけにくいバグである。だから、メインファイルのディレクトリからの相対パスを用いて、メインファイルのディレクトリをカレントディレクトリにしてからコンパイルすると良い。逆に、カレントディレクトリが/home/A/otherdirectoryにあって、

    $ pdflatex ../main.tex

などとすると、サブファイルの取り込み時にエラーが起きる。\\input\{subfile\.tex\}は、相対パスを絶対パスに変換した時、/home/A/otherdirectory/subfile\.texになるからである。Ltxをrequireするスクリプトにも同様のことがいえる。だから、まずメインファイルのディレクトリに、カレント・ディレクトリを移してからスクリプトを実行するのが安全である。
しかし、Ltxを呼び出すスクリプト側で上記のようなトラブルを起こさないようなサービスを組み込んでおくことはできる。それは、スクリプトが実行時にカレント・ディレクトリをメインファイルの置かれたディレクトリに移動するようにするのである。たとえばパスを表す引数がARGV\[0\]だとすると、

    dirname = File.dirname(ARGV[0])
    FileUtils.cd dirname
    basename = File.basename(ARGV[0]).gsub(/.tex$/,"")

このようなスクリプトを入れておくと、メインファイルのディレクトリ以外からスクリプトを呼び出しても動作するようになる。

    /home/A/otherdirectory $ ruby script.rb ../main.tex

これでも動作するようになる。ただ、カレント・ディレクトリをスクリプトが変更するという仕様をユーザに明らかにしておかないと、別のバグを引き起こす可能性があることに注意しなければならない。

### Ltxのクラス・メソッド

- new インスタンス生成。初期値として読み込むLaTeXファイルを指定できる。

### Ltxのインスタンス・メソッド

- deep\_each 各行に対しブロックで与えられた操作をする。このとき、ボディ内の\\inputコマンドは指定されたサブファイルの内容に置き換えられ、\\inputを含む行は行頭に%が付け加えられたコメントになる。プリアンブルの\\inputコマンドはそのまま残る。
- shallow\_each 浅いeachという意味で、サブファイルは含めない。メインファイルだけの各行を取り出す。\\inputを含む行もその中に含まれる。
- backup バックアップファイルを作る。メインもサブも両方作る。ファイル名\.bakがバックアップ名。
- write バッファの内容をメインファイル、サブファイルに書き出す。ファイルがあった場合は上書きする。
- files メインファイルを先頭に、サブファイルの一覧を表す配列を返す。

### Ltxのインストール

ltx.rbは$LOAD\_PATHの中に置き、

    require "ltx"

で取り込むことができるようにする。
$LOAD\_PATHがどう定義されるかはrubyのインストールに依存する。
例えば、rbenvでインストールした場合、

    $HOME/.rbenv/versions/2.6.0/lib/ruby/site_ruby/2.6.0/x86_64-linux

のようなフォルダがltx.rbを設置する場所になる。

これはユーザごとに環境が違うので、ユーザ側で場所を判断してもらうしかない。

